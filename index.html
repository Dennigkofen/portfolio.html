import React, { useState, useEffect } from 'react';
import { Plus, X, Star, Circle, Settings, BarChart3, BookOpen, Clock, TrendingUp } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, AreaChart, Area } from 'recharts';

const PortfolioDashboard = () => {
  const [subjects, setSubjects] = useState([]);
  const [activeTab, setActiveTab] = useState('overview');
  const [showAddSubject, setShowAddSubject] = useState(false);
  const [newSubjectName, setNewSubjectName] = useState('');
  const [timelineData, setTimelineData] = useState([]);

  // Initialize with sample data
  useEffect(() => {
    const sampleSubjects = [
      {
        id: 1,
        name: 'Mathematik',
        learningGoals: [
          { id: 1, title: 'Bruchrechnung verstehen', type: 'basic', status: 'achieved', weight: 3 },
          { id: 2, title: 'Gleichungen lösen', type: 'basic', status: 'partial', weight: 2 },
          { id: 3, title: 'Geometrische Körper', type: 'basic', status: 'not_achieved', weight: 2 },
          { id: 4, title: 'Komplexe Textaufgaben', type: 'advanced', status: 'achieved', weight: 1 },
          { id: 5, title: 'Wahrscheinlichkeitsrechnung', type: 'advanced', status: 'partial', weight: 2 }
        ]
      },
      {
        id: 2,
        name: 'Deutsch',
        learningGoals: [
          { id: 6, title: 'Rechtschreibung', type: 'basic', status: 'achieved', weight: 4 },
          { id: 7, title: 'Textverständnis', type: 'basic', status: 'achieved', weight: 3 },
          { id: 8, title: 'Aufsatz schreiben', type: 'basic', status: 'partial', weight: 2 },
          { id: 9, title: 'Gedichtanalyse', type: 'advanced', status: 'partial', weight: 1 },
          { id: 10, title: 'Rhetorik', type: 'advanced', status: 'not_achieved', weight: 1 }
        ]
      }
    ];
    
    // Generate sample timeline data for the school year
    const sampleTimelineData = [
      {
        date: 'Aug 2024',
        month: 'August',
        basicAchieved: 20,
        basicPartial: 40,
        basicNotAchieved: 40,
        advancedAchieved: 10,
        advancedPartial: 20,
        advancedNotAchieved: 70
      },
      {
        date: 'Sep 2024',
        month: 'September',
        basicAchieved: 30,
        basicPartial: 35,
        basicNotAchieved: 35,
        advancedAchieved: 15,
        advancedPartial: 25,
        advancedNotAchieved: 60
      },
      {
        date: 'Oct 2024',
        month: 'Oktober',
        basicAchieved: 45,
        basicPartial: 30,
        basicNotAchieved: 25,
        advancedAchieved: 20,
        advancedPartial: 30,
        advancedNotAchieved: 50
      },
      {
        date: 'Nov 2024',
        month: 'November',
        basicAchieved: 55,
        basicPartial: 25,
        basicNotAchieved: 20,
        advancedAchieved: 25,
        advancedPartial: 35,
        advancedNotAchieved: 40
      },
      {
        date: 'Dec 2024',
        month: 'Dezember',
        basicAchieved: 60,
        basicPartial: 25,
        basicNotAchieved: 15,
        advancedAchieved: 30,
        advancedPartial: 40,
        advancedNotAchieved: 30
      },
      {
        date: 'Jan 2025',
        month: 'Januar',
        basicAchieved: 65,
        basicPartial: 20,
        basicNotAchieved: 15,
        advancedAchieved: 35,
        advancedPartial: 35,
        advancedNotAchieved: 30
      },
      {
        date: 'Feb 2025',
        month: 'Februar',
        basicAchieved: 70,
        basicPartial: 20,
        basicNotAchieved: 10,
        advancedAchieved: 40,
        advancedPartial: 35,
        advancedNotAchieved: 25
      },
      {
        date: 'Mar 2025',
        month: 'März',
        basicAchieved: 75,
        basicPartial: 15,
        basicNotAchieved: 10,
        advancedAchieved: 45,
        advancedPartial: 30,
        advancedNotAchieved: 25
      },
      {
        date: 'Apr 2025',
        month: 'April',
        basicAchieved: 80,
        basicPartial: 15,
        basicNotAchieved: 5,
        advancedAchieved: 50,
        advancedPartial: 30,
        advancedNotAchieved: 20
      },
      {
        date: 'May 2025',
        month: 'Mai',
        basicAchieved: 85,
        basicPartial: 10,
        basicNotAchieved: 5,
        advancedAchieved: 55,
        advancedPartial: 25,
        advancedNotAchieved: 20
      },
      {
        date: 'Jun 2025',
        month: 'Juni',
        basicAchieved: 90,
        basicPartial: 8,
        basicNotAchieved: 2,
        advancedAchieved: 60,
        advancedPartial: 25,
        advancedNotAchieved: 15
      }
    ];
    
    setSubjects(sampleSubjects);
    setTimelineData(sampleTimelineData);
  }, []);

  const addSubject = () => {
    if (newSubjectName.trim()) {
      const newSubject = {
        id: Date.now(),
        name: newSubjectName.trim(),
        learningGoals: []
      };
      setSubjects([...subjects, newSubject]);
      setNewSubjectName('');
      setShowAddSubject(false);
    }
  };

  const removeSubject = (subjectId) => {
    setSubjects(subjects.filter(s => s.id !== subjectId));
    if (activeTab === `subject-${subjectId}`) {
      setActiveTab('overview');
    }
  };

  const addLearningGoal = (subjectId) => {
    const title = prompt('Titel des Lernziels:');
    const type = confirm('Ist dies eine Erweiterte Anforderung? (OK = Ja, Abbrechen = Grundanforderung)') ? 'advanced' : 'basic';
    const weight = parseInt(prompt('Gewichtung (1-5):') || '1');
    
    if (title) {
      const newGoal = {
        id: Date.now(),
        title: title.trim(),
        type,
        status: 'not_achieved',
        weight: Math.max(1, Math.min(5, weight))
      };
      
      setSubjects(subjects.map(s => 
        s.id === subjectId 
          ? { ...s, learningGoals: [...s.learningGoals, newGoal] }
          : s
      ));
    }
  };

  const updateGoalStatus = (subjectId, goalId, newStatus) => {
    setSubjects(subjects.map(s => 
      s.id === subjectId 
        ? {
            ...s, 
            learningGoals: s.learningGoals.map(g => 
              g.id === goalId ? { ...g, status: newStatus } : g
            )
          }
        : s
    ));
  };

  const removeGoal = (subjectId, goalId) => {
    setSubjects(subjects.map(s => 
      s.id === subjectId 
        ? { ...s, learningGoals: s.learningGoals.filter(g => g.id !== goalId) }
        : s
    ));
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'achieved': return '#22c55e';
      case 'partial': return '#f59e0b';
      case 'not_achieved': return '#ef4444';
      default: return '#6b7280';
    }
  };

  const getStatusText = (status) => {
    switch (status) {
      case 'achieved': return 'Erreicht';
      case 'partial': return 'Teilweise erreicht';
      case 'not_achieved': return 'Noch nicht erreicht';
      default: return 'Unbewertet';
    }
  };

  const getBubbleData = (subject) => {
    const data = {};
    
    subject.learningGoals.forEach(goal => {
      const key = `${goal.type}-${goal.status}`;
      if (!data[key]) {
        data[key] = { type: goal.type, status: goal.status, count: 0, totalWeight: 0 };
      }
      data[key].count += 1;
      data[key].totalWeight += goal.weight;
    });
    
    return Object.values(data);
  };

  const TimelineVisualization = () => {
    return (
      <div className="space-y-6">
        {/* Grundanforderungen Timeline */}
        <div className="bg-white p-6 rounded-lg shadow-sm border">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <Clock className="w-5 h-5" />
            Entwicklung Grundanforderungen im Schuljahr
          </h3>
          <div style={{ width: '100%', height: '300px' }}>
            <ResponsiveContainer>
              <AreaChart data={timelineData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="month" 
                  tick={{ fontSize: 12 }}
                />
                <YAxis 
                  label={{ value: 'Prozent (%)', angle: -90, position: 'insideLeft' }}
                  tick={{ fontSize: 12 }}
                />
                <Tooltip 
                  formatter={(value, name) => [`${value}%`, name]}
                  labelFormatter={(label) => `Monat: ${label}`}
                />
                <Legend />
                <Area 
                  type="monotone" 
                  dataKey="basicAchieved" 
                  stackId="1" 
                  stroke="#22c55e" 
                  fill="#22c55e" 
                  name="Erreicht"
                />
                <Area 
                  type="monotone" 
                  dataKey="basicPartial" 
                  stackId="1" 
                  stroke="#f59e0b" 
                  fill="#f59e0b" 
                  name="Teilweise erreicht"
                />
                <Area 
                  type="monotone" 
                  dataKey="basicNotAchieved" 
                  stackId="1" 
                  stroke="#ef4444" 
                  fill="#ef4444" 
                  name="Noch nicht erreicht"
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Erweiterte Anforderungen Timeline */}
        <div className="bg-white p-6 rounded-lg shadow-sm border">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <Star className="w-5 h-5" />
            Entwicklung Erweiterte Anforderungen im Schuljahr
          </h3>
          <div style={{ width: '100%', height: '300px' }}>
            <ResponsiveContainer>
              <AreaChart data={timelineData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="month" 
                  tick={{ fontSize: 12 }}
                />
                <YAxis 
                  label={{ value: 'Prozent (%)', angle: -90, position: 'insideLeft' }}
                  tick={{ fontSize: 12 }}
                />
                <Tooltip 
                  formatter={(value, name) => [`${value}%`, name]}
                  labelFormatter={(label) => `Monat: ${label}`}
                />
                <Legend />
                <Area 
                  type="monotone" 
                  dataKey="advancedAchieved" 
                  stackId="1" 
                  stroke="#22c55e" 
                  fill="#22c55e" 
                  name="Erreicht"
                />
                <Area 
                  type="monotone" 
                  dataKey="advancedPartial" 
                  stackId="1" 
                  stroke="#f59e0b" 
                  fill="#f59e0b" 
                  name="Teilweise erreicht"
                />
                <Area 
                  type="monotone" 
                  dataKey="advancedNotAchieved" 
                  stackId="1" 
                  stroke="#ef4444" 
                  fill="#ef4444" 
                  name="Noch nicht erreicht"
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Kombinierte Trendlinie */}
        <div className="bg-white p-6 rounded-lg shadow-sm border">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <TrendingUp className="w-5 h-5" />
            Fortschrittstrend: Erreichte Lernziele
          </h3>
          <div style={{ width: '100%', height: '300px' }}>
            <ResponsiveContainer>
              <LineChart data={timelineData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="month" 
                  tick={{ fontSize: 12 }}
                />
                <YAxis 
                  label={{ value: 'Prozent (%)', angle: -90, position: 'insideLeft' }}
                  tick={{ fontSize: 12 }}
                />
                <Tooltip 
                  formatter={(value, name) => [`${value}%`, name]}
                  labelFormatter={(label) => `Monat: ${label}`}
                />
                <Legend />
                <Line 
                  type="monotone" 
                  dataKey="basicAchieved" 
                  stroke="#22c55e" 
                  strokeWidth={3}
                  dot={{ fill: '#22c55e', strokeWidth: 2, r: 4 }}
                  name="Grundanforderungen erreicht"
                />
                <Line 
                  type="monotone" 
                  dataKey="advancedAchieved" 
                  stroke="#3b82f6" 
                  strokeWidth={3}
                  strokeDasharray="5 5"
                  dot={{ fill: '#3b82f6', strokeWidth: 2, r: 4 }}
                  name="Erweiterte Anforderungen erreicht"
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Zusammenfassung */}
        <div className="bg-white p-6 rounded-lg shadow-sm border">
          <h3 className="text-lg font-semibold mb-4">Entwicklung im Überblick</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-3">
              <h4 className="font-medium text-gray-700">Grundanforderungen</h4>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span>August 2024:</span>
                  <span className="text-green-600 font-medium">20% erreicht</span>
                </div>
                <div className="flex justify-between">
                  <span>Juni 2025:</span>
                  <span className="text-green-600 font-medium">90% erreicht</span>
                </div>
                <div className="flex justify-between border-t pt-2">
                  <span className="font-medium">Fortschritt:</span>
                  <span className="text-green-600 font-bold">+70%</span>
                </div>
              </div>
            </div>
            <div className="space-y-3">
              <h4 className="font-medium text-gray-700">Erweiterte Anforderungen</h4>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span>August 2024:</span>
                  <span className="text-blue-600 font-medium">10% erreicht</span>
                </div>
                <div className="flex justify-between">
                  <span>Juni 2025:</span>
                  <span className="text-blue-600 font-medium">60% erreicht</span>
                </div>
                <div className="flex justify-between border-t pt-2">
                  <span className="font-medium">Fortschritt:</span>
                  <span className="text-blue-600 font-bold">+50%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const BubbleVisualization = ({ subject }) => {
    const bubbleData = getBubbleData(subject);
    const maxWeight = Math.max(...bubbleData.map(b => b.totalWeight), 1);
    
    return (
      <div className="bg-white p-6 rounded-lg shadow-sm border">
        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
          <BarChart3 className="w-5 h-5" />
          Kompetenzübersicht: {subject.name}
        </h3>
        <div className="flex flex-wrap gap-8 justify-center items-center min-h-[300px]">
          {bubbleData.map((bubble, index) => {
            const size = 40 + (bubble.totalWeight / maxWeight) * 120;
            const color = getStatusColor(bubble.status);
            
            return (
              <div 
                key={index}
                className="flex flex-col items-center gap-2 relative group"
              >
                <div 
                  className="flex items-center justify-center text-white font-bold shadow-lg hover:scale-105 transition-transform cursor-pointer"
                  style={{
                    width: `${size}px`,
                    height: `${size}px`,
                    backgroundColor: color,
                    borderRadius: bubble.type === 'basic' ? '50%' : '0%',
                    clipPath: bubble.type === 'advanced' ? 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)' : 'none'
                  }}
                >
                  {bubble.count}
                </div>
                <div className="text-center text-sm">
                  <div className="font-medium">
                    {bubble.type === 'basic' ? 'Grundanforderungen' : 'Erweiterte Anforderungen'}
                  </div>
                  <div className="text-gray-600">
                    {getStatusText(bubble.status)}
                  </div>
                  <div className="text-xs text-gray-500">
                    {bubble.count} Lernziel{bubble.count !== 1 ? 'e' : ''}
                  </div>
                </div>
                
                {/* Tooltip */}
                <div className="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                  Gewichtung: {bubble.totalWeight}
                </div>
              </div>
            );
          })}
        </div>
        <div className="mt-6 text-sm text-gray-600 bg-gray-50 p-3 rounded">
          <strong>Legende:</strong> Kreise = Grundanforderungen, Sterne = Erweiterte Anforderungen. 
          Größe = Anzahl Lernziele, Farbe = Erreichungsgrad.
        </div>
      </div>
    );
  };

  const SubjectManagement = ({ subject }) => {
    return (
      <div className="space-y-6">
        <BubbleVisualization subject={subject} />
        
        <div className="bg-white p-6 rounded-lg shadow-sm border">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <Settings className="w-5 h-5" />
              Lernziele verwalten
            </h3>
            <button
              onClick={() => addLearningGoal(subject.id)}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              <Plus className="w-4 h-4" />
              Lernziel hinzufügen
            </button>
          </div>
          
          <div className="space-y-3">
            {subject.learningGoals.length === 0 ? (
              <p className="text-gray-500 text-center py-8">
                Noch keine Lernziele definiert. Fügen Sie das erste Lernziel hinzu.
              </p>
            ) : (
              subject.learningGoals.map(goal => (
                <div key={goal.id} className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-2 text-gray-600">
                    {goal.type === 'basic' ? <Circle className="w-4 h-4" /> : <Star className="w-4 h-4" />}
                    <span className="text-xs">
                      {goal.type === 'basic' ? 'Grund' : 'Erweitert'} (Gew: {goal.weight})
                    </span>
                  </div>
                  
                  <div className="flex-1">
                    <span className="font-medium">{goal.title}</span>
                  </div>
                  
                  <select
                    value={goal.status}
                    onChange={(e) => updateGoalStatus(subject.id, goal.id, e.target.value)}
                    className="px-3 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                    style={{ color: getStatusColor(goal.status) }}
                  >
                    <option value="not_achieved">Noch nicht erreicht</option>
                    <option value="partial">Teilweise erreicht</option>
                    <option value="achieved">Erreicht</option>
                  </select>
                  
                  <button
                    onClick={() => removeGoal(subject.id, goal.id)}
                    className="p-1 text-red-600 hover:bg-red-100 rounded transition-colors"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100">
      <div className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <BookOpen className="w-6 h-6" />
            Kompetenzorientiertes Portfolio
          </h1>
        </div>
      </div>
      
      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex gap-6">
          {/* Sidebar */}
          <div className="w-64 bg-white rounded-lg shadow-sm border p-4">
            <div className="flex justify-between items-center mb-4">
              <h2 className="font-semibold">Fächer</h2>
              <button
                onClick={() => setShowAddSubject(true)}
                className="p-1 text-blue-600 hover:bg-blue-100 rounded transition-colors"
              >
                <Plus className="w-4 h-4" />
              </button>
            </div>
            
            {showAddSubject && (
              <div className="mb-4 p-3 bg-gray-50 rounded">
                <input
                  type="text"
                  value={newSubjectName}
                  onChange={(e) => setNewSubjectName(e.target.value)}
                  placeholder="Fachname"
                  className="w-full px-2 py-1 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onKeyPress={(e) => e.key === 'Enter' && addSubject()}
                />
                <div className="flex gap-2 mt-2">
                  <button
                    onClick={addSubject}
                    className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                  >
                    Hinzufügen
                  </button>
                  <button
                    onClick={() => {setShowAddSubject(false); setNewSubjectName('');}}
                    className="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400"
                  >
                    Abbrechen
                  </button>
                </div>
              </div>
            )}
            
            <nav className="space-y-1">
              <button
                onClick={() => setActiveTab('overview')}
                className={`w-full text-left px-3 py-2 rounded transition-colors ${
                  activeTab === 'overview' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                }`}
              >
                Übersicht
              </button>
              
              <button
                onClick={() => setActiveTab('timeline')}
                className={`w-full text-left px-3 py-2 rounded transition-colors ${
                  activeTab === 'timeline' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                }`}
              >
                Timeline
              </button>
              
              {subjects.map(subject => (
                <div key={subject.id} className="flex items-center group">
                  <button
                    onClick={() => setActiveTab(`subject-${subject.id}`)}
                    className={`flex-1 text-left px-3 py-2 rounded transition-colors ${
                      activeTab === `subject-${subject.id}` ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                    }`}
                  >
                    {subject.name}
                  </button>
                  <button
                    onClick={() => removeSubject(subject.id)}
                    className="p-1 text-red-600 opacity-0 group-hover:opacity-100 hover:bg-red-100 rounded transition-all"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </div>
              ))}
            </nav>
          </div>
          
          {/* Main Content */}
          <div className="flex-1">
            {activeTab === 'overview' ? (
              <div className="space-y-6">
                <div className="bg-white p-6 rounded-lg shadow-sm border">
                  <h2 className="text-xl font-semibold mb-4">Portfolio-Übersicht</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {subjects.map(subject => {
                      const totalGoals = subject.learningGoals.length;
                      const achievedGoals = subject.learningGoals.filter(g => g.status === 'achieved').length;
                      const partialGoals = subject.learningGoals.filter(g => g.status === 'partial').length;
                      
                      return (
                        <div key={subject.id} className="p-4 border rounded-lg hover:shadow-md transition-shadow">
                          <h3 className="font-semibold mb-2">{subject.name}</h3>
                          <div className="text-sm text-gray-600 space-y-1">
                            <div>Lernziele gesamt: {totalGoals}</div>
                            <div className="text-green-600">Erreicht: {achievedGoals}</div>
                            <div className="text-yellow-600">Teilweise: {partialGoals}</div>
                            <div className="text-red-600">Offen: {totalGoals - achievedGoals - partialGoals}</div>
                          </div>
                          <button
                            onClick={() => setActiveTab(`subject-${subject.id}`)}
                            className="mt-3 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                          >
                            Details anzeigen
                          </button>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
